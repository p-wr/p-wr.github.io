#!/usr/bin/env node
(()=>{"use strict";var e,t,s={696:(e,t,s)=>{var r=s(747),i=s.n(r),a=s(622),o=s.n(a);const n=require("commander");var c=s.n(n);const l=require("jquery");var p=s.n(l);class h{richpp2HTML(e){if(e.constructor!==Array)return e;var t,s,r,i,a,o;switch([s,r]=e,s){case"Element":[i,a,o]=r;let s=o.map(this.richpp2HTML,this);t=`<span class="${i}">`+(t="".concat(...s))+"</span>";break;case"PCData":t=r;break;default:t=e}return t}pp2DOM(e){if(e.constructor!==Array)throw new Error("malformed Pp element: "+e);var[t,s]=e;switch(t){case"Pp_glue":return s.length>0?s.map((e=>this.pp2DOM(e))).reduce(((e,t)=>e.add(t))):p()([]);case"Pp_string":return p()(document.createTextNode(s));case"Pp_box":let t="Pp_vbox"==s[0]?"vertical":"horizontal";return this.adjustBox(p()("<div>").addClass("Pp_box").attr("data-mode",t).append(this.pp2DOM(e[2])));case"Pp_tag":return this._wrapTrimmed(this.pp2DOM(e[2]),p()("<span>").addClass(s));case"Pp_force_newline":return p()("<br/>").addClass("Pp_force_newline");case"Pp_print_break":return p()("<span>").addClass("Pp_break").attr("data-break",e.slice(1)).text(" ");case"Pp_empty":return p()([]);default:return console.warn("unhandled Format case",e),p()([])}}pp2HTML(e,t){if(e.constructor!==Array)return e;var s,r,i;switch(t=t||{breakMode:"horizontal"},[r,i]=e,r){case"Pp_glue":let r=i.map((e=>this.pp2HTML(e,t)));s="".concat(...r);break;case"Pp_string":i.match(/^={4}=*$/)?(s="<hr/>",t.breakMode="skip-vertical"):"vertical"===t.breakMode&&i.match(/^\ +$/)?(s="",t.margin=i):s=i;break;case"Pp_box":var a=t.breakMode,o=t.margin?t.margin.length:0;switch(t.margin=null,e[1][0]){case"Pp_vbox":t.breakMode="vertical";break;default:t.breakMode="horizontal"}s=`<div class="Pp_box" data-mode="${t.breakMode}" data-margin="${o}">`+this.pp2HTML(e[2],t)+"</div>",t.breakMode=a;break;case"Pp_tag":s=this.pp2HTML(e[2],t),s=`<span class="${e[1]}">`+s+"</span>";break;case"Pp_force_newline":s="<br/>",t.margin=null;break;case"Pp_print_break":s="",t.margin=null,"vertical"===t.breakMode||0==e[1]&&e[2]>0?s="<br/>":"horizontal"===t.breakMode?s=`<span class="Pp_break" data-break="${e.slice(1)}"> </span>`:"skip-vertical"===t.breakMode&&(t.breakMode="vertical");break;case"Pp_empty":s="";break;default:console.warn("unhandled Format case",e),s=e}return s}pp2Text(e,t){if(!Array.isArray(e))return e;var s,r,i;switch(t=t||{breakMode:"horizontal"},[r,i]=e,r){case"Pp_glue":let r=i.map((e=>this.pp2Text(e,t)));s="".concat(...r);break;case"Pp_string":"vertical"===t.breakMode&&i.match(/^\ +$/)?(s="",t.margin=i):s=i;break;case"Pp_box":var a=t.breakMode;switch(t.margin&&t.margin.length,t.margin=null,e[1][0]){case"Pp_vbox":t.breakMode="vertical";break;default:t.breakMode="horizontal"}s=this.pp2Text(e[2],t),t.breakMode=a;break;case"Pp_tag":s=this.pp2Text(e[2],t);break;case"Pp_force_newline":s="\n",t.margin=null;break;case"Pp_print_break":s="",t.margin=null,"vertical"===t.breakMode||0==e[1]&&e[2]>0?s="\n":"horizontal"===t.breakMode?s=" ":"skip-vertical"===t.breakMode&&(t.breakMode="vertical");break;case"Pp_empty":s="";break;default:console.warn("unhandled Format case",e),s=e}return s}goals2DOM(e){var t=e.goals.length,s=this.flatLength(e.stack),r=e.shelf.length,i=e.given_up.length;function a(e){var t=p()("<p>").addClass("aside");return"string"==typeof e?t.text(e):t.append(e)}if(0===t){let t=s?"This subproof is complete, but there are some unfocused goals.":r?"All the remaining goals are on the shelf.":"No more goals.",o=i?[`(${i} goal${i>1?"s were":" was"} admitted.)`]:[],n=(e.bullet?[this.pp2DOM(e.bullet)]:[]).concat(o);return p()("<div>").append(p()("<p>").addClass("no-goals").text(t),n.map(a))}{let s=1===t?"1 goal":`${t} goals`,i=r?[`(shelved: ${r})`]:[],o=this.goal2DOM(e.goals[0]),n=e.goals.slice(1).map(((e,t)=>p()("<div>").addClass("coq-subgoal-pending").append(p()("<label>").text(t+2)).append(this.pp2DOM(e.ty))));return p()("<div>").append(p()("<p>").addClass("num-goals").text(s),i.map(a),o,n)}}goal2DOM(e){let t=e=>p()("<label>").text(this.constructor._idToString(e)),s=e=>p()("<span>").addClass("def").append(this.pp2DOM(e)),r=e.hyp.reverse().map((([e,r,i])=>p()("<div>").addClass(["coq-hypothesis",r&&"coq-has-def"]).append(e.map(t)).append(r&&s(r)).append(this.pp2DOM(i)))),i=this.pp2DOM(e.ty);return p()("<div>").addClass("coq-env").append(r,p()("<hr/>"),i)}static _idToString(e){return console.assert("Id"===e[0]),e[1]}flatLength(e){return Array.isArray(e)?e.map((e=>this.flatLength(e))).reduce(((e,t)=>e+t),0):1}adjustBox(e){if("vertical"==e.attr("data-mode"))for(let t of e.children(".Pp_break"))p()(t).replaceWith(p()("<br/>"));return e}adjustBreaks(e){var t=e.width(),s=e.add(e.find('.Pp_box[data-mode="horizontal"]'));for(let e of s){let s=p()(e),i=s.children(".Pp_break");var r=null;for(let e of i)r&&p()(e).position().left>=t&&r.html("<br/>"),r=p()(e);r&&s.position().left+s.width()>t&&r.html("<br/>")}0==e.children().length&&e.addClass("text-only")}_wrapTrimmed(e,t){if(0===e.length)return t;var s,r,i=e[0],a=e[e.length-1];return i.nodeType===Node.TEXT_NODE&&(s=i.nodeValue.match(/^\s*/)[0],i.nodeValue=i.nodeValue.substring(s.length)),a.nodeType===Node.TEXT_NODE&&(r=a.nodeValue.match(/\s*$/),a.nodeValue=a.nodeValue.substring(0,r.index),r=r[0]),p()([s&&document.createTextNode(s),t.append(e)[0],r&&document.createTextNode(r)].filter((e=>e)))}}const d={fs:function(){try{return s(747)}catch(e){return{}}}(),path:s(622)};class u{constructor(e=d){this.volume=e,this.searchPath=new _(e),this.deps=[],this.extern=new Set}processPackage(e){this.processModules(this.searchPath.modulesOf(e))}processModules(e){for(let t of e)this.processModule(t)}processModule(e){e.physical.endsWith(".v")&&this.processVernacFile(e.physical,e)}processVernacFile(e,t){(t=t||{volume:this.volume,logical:this.searchPath.toLogical(e),physical:e}).logical&&this.processVernac(t.volume.fs.readFileSync(e,"utf-8"),t)}processVernac(e,t){var s=[...this._extractImports(e)];s.length>0&&this.deps.push({from:t,to:s});for(let e of this._getExtern(s))this.extern.add(e)}depsOf(e){var t=this.deps.find((t=>t.from.physical===e.physical));return t?t.to:[]}depsToJson(){var e={},t=e=>e.logical.join(".");for(let s of this.deps)e[t(s.from)]=s.to.map(t);return e}buildOrder(e){e||(e=this.searchPath.modules());var t=new Map,s=new Map,r=e=>e.logical.join(".");for(let{from:e,to:s}of this.deps){let i=r(e);for(let e of s){let s=r(e);t.set(s,(t.get(s)||[]).concat([i]))}}for(let t of e){var i=r(t);!t.physical.endsWith(".v")&&s.has(i)||s.set(i,t)}return this._topologicalSort([...s.keys()],t).map((e=>s.get(e)))}_topologicalSort(e,t){var s=new Map;for(let r of e)s.set(r,e.filter((e=>(t.get(e)||[]).includes(r))).length);for(var r=[],i=e.filter((e=>!s.get(e)));i.length>0;){var a=i.shift();r.push(a);for(let e of t.get(a)||[]){let t=s.get(e)-1;s.set(e,t),0==t&&i.push(e)}}return r.length<e.length&&console.warn("coqdep: cyclic dependency detected",e.filter((e=>-1==r.indexOf(e)))),r}_extractImports(e){return this._uniqBy(this._extractImportsBase(e),(e=>e.logical.join(".")))}*_extractImportsBase(e){e=e.replace(/\(\*[^]*?\*\)/g," ");for(let n of e.split(/[.](?:\s|$)/)){var t=/^\s*(?:From\s+(.*?)\s+)?Require(\s+(?:Import|Export))*\s+(.*)/.exec(n);if(t){var[s,r,i,a]=t,o=a.split(/\s+/);for(let e of o)for(let t of this._resolve(r,e))yield t}}}_resolve(e,t){return this.searchPath.findModules(e,t)}*_getExtern(e){var t=this.searchPath.packageIndex;if(t)for(let s of e)yield*t.findPackageDeps(null,s.logical,!0)}*_uniqBy(e,t){var s=new Set;for(let i of[...e]){var r=t(i);s.has(r)||(s.add(r),yield i)}}}const f=require("array-equal");var m=s.n(f);const g=require("fflate"),y=require("neatjson"),v=d.fs;class w{constructor(e,t=d){this.volume=t,this.name=e,this.deps=[],this.searchPath=new _(t),this.opts={json:{padding:1,afterColon:1,afterComma:1,wrap:80},zip:{}}}fromJson(e,t="",s=this.volume){for(let n in e){var r=this.toDirPath(e[n].prefix||"");for(let c of e[n].dirpaths||[""]){var i=this.toDirPath(c),a=s.path.join(t,n,...i),o={volume:s,physical:a,logical:r.concat(i),pkg:this.name};"string"==typeof c||c.rec?this.searchPath.addRecursive(o):this.searchPath.add(o)}}return this}fromDirectory(e="",t=this.volume){try{var s=t.fs.readFileSync(t.path.join(e,"_CoqProject"),"utf-8")}catch(e){}return s?this.fromCoqMF(s,e,t):(this.searchPath.addRecursive({volume:t,physical:e,logical:"",pkg:this.name}),this)}fromCoqMF(e,t="",s=this.volume){var r=this.name,i=[];for(let l of e.split(/\n+/)){var a=/^\s*(-[RQ])\s+(\S+)\s+(\S+)/.exec(l);if(a){var[o,n,c]=[a[1],a[2],a[3]];n=s.path.join(t,n),"-R"===o?this.searchPath.addRecursive({volume:s,physical:n,logical:c,pkg:r}):this.searchPath.add({volume:s,physical:n,logical:c,pkg:r})}else for(let e of l.matchAll(/\S+[.]v/g))i.push(e[0])}return i.length>0&&this.setModules(i),this}setModules(e){this._modules=e.map((e=>"string"==typeof e?{volume:this.volume,physical:e,logical:this.searchPath.toLogical(e),pkg:this.name}:e))}computeDeps(){var e=new u;return e.searchPath=this.searchPath,e.processModules(this.modules()),e}modules(){return this._modules||this.searchPath.modulesOf(this.name)}modulesByExt(e){return this.modulesByExts([e])}*modulesByExts(e){for(let t of this.modules())e.some((e=>t.physical.endsWith(e)))&&(yield t)}listModules(){return this.searchPath._listNames(this.modules())}createManifest(){var e=this.computeDeps().depsToJson(),t={};for(let s of this.listModules())t[s]=e[s]?{deps:e[s]}:{};return{name:this.name,deps:this.deps,modules:t}}toDirPath(e){return this.searchPath.toDirPath("string"==typeof e?e:e.logical)}copyLogical(e=new j){for(let{volume:t,physical:s,logical:r}of this.modulesByExt(".v"))e.fs.writeFileSync(`/${r.join("/")}.v`,t.fs.readFileSync(s));return new w(this.name,e).fromDirectory("/")}async toZip(e,t=[".vo",".cma"],s=(e=>[e])){var r=new b(this.opts.zip);e&&r.writeFileSync("coq-pkg.json",e);for(let e of this.modulesByExts(t))for(let t of s(e)){var i=t.ext||t.physical.match(/[.][^.]+$/)[0];try{r.writeFileSync(t.logical.join("/")+i,t.payload||t.volume.fs.readFileSync(t.physical))}catch(e){console.warn(`skipped ${t.physical} (${e})`)}}return r}async toPackage(e=this.name,t,s=(e=>[e]),r=(e=>e)){e.match(/[.][^./]+$/)||(e+=".coq-pkg");var i=r(this.createManifest(),e),a=e.replace(/[.][^./]+$/,".json"),o=(0,y.neatJSON)(i,this.opts.json);return new k({filename:e,zip:await this.toZip(o,t,s)},{filename:a,json:o,object:i})}}class b{constructor(e){this.z={},this.opts=e}writeFileSync(e,t){"string"==typeof t&&(t=(new TextEncoder).encode(t)),this.z[e]=t}zipSync(){return(0,g.zipSync)(this.z)}}class k{constructor(e,t){this.pkg=e,this.manifest=t}async save(e){const t=s(841).sync;return t(o().dirname(this.pkg.filename)),e?(e.chunks||(e.chunks=[]),e.chunks.push(this.manifest.object)):(t(o().dirname(this.manifest.filename)),v.writeFileSync(this.manifest.filename,this.manifest.json)),v.writeFileSync(this.pkg.filename,this.pkg.zip.zipSync()),this}}class _{constructor(e=d){this.volume=e,this.path=[]}add({volume:e,physical:t,logical:s,pkg:r}){e=e||this.volume,s=this.toDirPath(s),this.has({volume:e,physical:t,logical:s,pkg:r})||this.path.push({volume:e,logical:s,physical:t,pkg:r})}addRecursive({volume:e,physical:t,logical:s,pkg:r}){e=e||this.volume,s=this.toDirPath(s),this.add({volume:e,physical:t,logical:s,pkg:r});for(let a of e.fs.readdirSync(t)){var i=e.path.join(t,a);e.fs.statSync(i).isDirectory()&&this.addRecursive({volume:e,physical:i,logical:s.concat([a]),pkg:r})}}addFrom(e){e instanceof w&&(e=e.searchPath),this.path.push(...e.path)}has({volume:e,physical:t,logical:s,pkg:r}){return void 0!==s&&(s=this.toDirPath(s)),this.path.find((i=>{(void 0===e||i.volume===e)&&(void 0===t||i.physical===t)&&(void 0===s||m()(i.logical,s))&&(void 0===r||i.pkg)}))}toLogical(e){var t=this.volume.path.dirname(e),s=this.volume.path.basename(e).replace(/[.]vo?$/,"");for(let{logical:e,physical:r}of this.path)if(r===t)return e.concat([s])}toDirPath(e){return"string"==typeof e?e.split(".").filter((e=>e)):e}*modules(){for(let{volume:e,logical:t,physical:s,pkg:r}of this.path)for(let i of e.fs.readdirSync(s))if(i.match(/[.](vo?|cma)$/)){let a=i.replace(/[.](vo?|cma)$/,""),o=e.path.join(s,i);yield{volume:e,logical:t.concat([a]),physical:o,pkg:r}}}*modulesOf(e){for(let t of this.modules())t.pkg===e&&(yield t)}modulesByExt(e){return this.modulesByExts([e])}*modulesByExts(e){for(let t of this.modules())e.some((e=>t.physical.endsWith(e)))&&(yield t)}listModules(){return this._listNames(this.modules())}listModulesOf(e){return this._listNames(this.modulesOf(e))}_listNames(e){let t=new Set,s=e=>e.logical.join(".");for(let r of e)t.add(s(r));return t}*findModules(e,t,s=!1){yield*this.moduleIndex?this.moduleIndex.findModules(e,t,s):this._findModules(e,t,s),yield*this._findExtern(e,t,s)}*_findModules(e,t,s=!1){var r=this.toDirPath(e)||[],i=this.toDirPath(t);let a=s?e=>m()(e,r.concat(i)):e=>{return((e,t)=>m()(e.slice(0,t.length),t))(e,r)&&(t=e,0==(s=i).length||m()(t.slice(-s.length),s));var t,s};for(let e of this.modules())a(e.logical)&&(yield e)}*_findExtern(e,t,s=!1){if(this.packageIndex)for(let r of this.packageIndex.findModules(e,t,s))yield{volume:null,physical:null,logical:r.split("."),pkg:"+"}}createIndex(){this.moduleIndex=new x;for(let e of this.modules())this.moduleIndex.add(e);return this.moduleIndex}}class x{constructor(){this.index=new Map}add(e){this.index.set((e=>e.logical.join("."))(e),e)}*findModules(e,t,s=!1){if(Array.isArray(e)&&(e=e.join(".")),Array.isArray(t)&&(t=t.join(".")),e=e?e+".":"",s){var r=this.index.get(e+t);r&&(yield r)}else{var i="."+t;for(let[s,r]of this.index.entries())s.startsWith(e)&&(s==t||s.endsWith(i))&&(yield r)}}}class P{constructor(){this.fs=this,this.path=d.path}readdirSync(e){let t=[];""===e||e.endsWith("/")||(e+="/");for(let r of this._files)if(r.startsWith(e)){var s=r.substring(e.length).split("/").filter((e=>e));s[0]&&!t.includes(s[0])&&t.push(s[0])}return t}statSync(e){var t=e.replace(/(^|([^/]))$/,"$2/");for(let e of this._files)if(e.startsWith(t))return{isDirectory:()=>!0};throw new Error(`ENOENT: '${e}'`)}}class j extends P{constructor(){super(),this.fileMap=new Map}get _files(){return this.fileMap.keys()}writeFileSync(e,t){"string"==typeof t&&(t=(new TextEncoder).encode(t)),this.fileMap.set(e,t)}readFileSync(e,t){var s=this.fileMap.get(e);if(s)return t?(new TextDecoder).decode(s):s;throw new Error(`ENOENT: '${e}'`)}statSync(e){return this.fileMap.get(e)?{isDirectory:()=>!1}:super.statSync(e)}renameSync(e,t){e!==t&&(this.fileMap.set(t,this.readFileSync(e)),this.fileMap.delete(e))}unlinkSync(e){this.fileMap.delete(e)}}class q extends P{constructor(e){super(),this.zip=e,this._files=[],this.zip.forEach((e=>this._files.push(e)))}readFileSync(e,t){var s=this.zip.files[e];if(s)return this._inflateSync(s);throw new Error(`ENOENT: ${e}`)}statSync(e){var t=this.zip.files[e]||this.zip.files[e+"/"];return t?{isDirectory:()=>t&&t.dir}:super.statSync(e)}static async fromFile(e){const t=S(await Promise.resolve().then(s.t.bind(s,395,23)));return new q(await t.loadAsync((0,v.readFileSync)(e)))}static async fromBlob(e){const t=S(await Promise.resolve().then(s.t.bind(s,395,23)));return new q(await t.loadAsync(e))}_inflateSync(e){const{DEFLATE:t}=s(218),{inflateRaw:r}=s(846);return e._data.compression==t?r(e._data.compressedContent):e._data.compressedContent}}function S(e){return e.default||e}class M{static transpilePluginsJs(e){if(e.physical.endsWith(".cma")){const t=s(129),r=e.physical,i=`${r}.js`;return t.execSync(`js_of_ocaml --wrap-with-fun= -o ${i} ${r}`),[{...e,payload:new Uint8Array},{...e,physical:i,ext:".cma.js"}]}return[e]}static backportManifest(e,t){var s={};for(let t in e.modules){var[r,i]=t.split(/[.]([^.]+)$/);(s[r]=s[r]||[]).push(i)}var a=Object.entries(s).map((([e,t])=>({pkg_id:e.split("."),vo_files:t.map((e=>[`${e}.vo`,null])),cma_files:[]}))),n={};for(let t in e.modules){var c=e.modules[t].deps;c&&(n[t]=c)}var l=e.archive||t&&o().basename(t);return{desc:e.name,deps:e.deps||[],archive:l,pkgs:a,modDeps:n}}}const $=require("events");class O extends $.EventEmitter{constructor(e,t,s={}){super(),this.infiles=[],this.outfiles=[],this._stop=!1,this.batch=e,this.inproj=t,this.opts={...O.DEFAULT_OPTIONS,...s},this.volume=e.volume||new j}async run(e){if(!this._stop){var t=this.inproj.computeDeps(),s=t.buildOrder();await this.batch.loadPackages(t.extern),await this.batch.init();for(let e of s){if(this._stop)break;e.physical.endsWith(".v")&&this.alreadyDone(t.depsOf(e))&&await this.compile(e)}return this.output(e)}}alreadyDone(e){return e.every((e=>!e.volume||this.outfiles.some((t=>m()(t.logical,e.logical)))))}async compile(e,t=this.opts){var{volume:s,logical:r,physical:i}=e,a=t.buildDir||"/lib",n=`${o().join(a,...r)}.v`,c=`${n}o`;this.infiles.push(e),this.emit("progress",[{filename:i,status:"compiling"}]);try{let[,[,t,o]]=await this.batch.do(["Put",n,s.fs.readFileSync(i)],["NewDoc",this.batch.docOpts(e,c)],["Load",n],(e=>"Loaded"==e[0]),["Compile",c],(e=>"Compiled"==e[0]));await this.batch.install(e,this.volume,a,c,t,o),this.outfiles.push({volume:this.volume,logical:r,physical:c}),this.emit("progress",[{filename:i,status:"compiled"}])}catch(s){if(this.emit("report",s,e),this.emit("progress",[{filename:i,status:"error"}]),!t.keepGoing)throw s}}stop(){this._stop=!0}output(e){this.outproj=new w(e||this.inproj.name||"out",this.volume);for(let e of this.outfiles)e.pkg=this.outproj.name,this.outproj.searchPath.add({physical:o().dirname(e.physical),logical:e.logical.slice(0,-1)});return this.outproj.setModules(this._files()),this.outproj}toPackage(e,t){return this.outproj.toPackage(e,t,this.opts.jscoq?M.transpilePluginsJs:void 0,this.opts.jscoq?M.backportManifest:void 0)}_files(){return[].concat(this.infiles,this.outfiles)}}O.DEFAULT_OPTIONS={buildDir:"/lib",resume:!1,keepGoing:!0,jscoq:!1};const D=["Coq.Init.Prelude"];class E{constructor(e){this.batch=e}async prepare(){await this.batch.do(["Init",{}],["NewDoc",{}],(e=>"Ready"===e[0]))}async runVernac(e){let t=e=>["Add",null,null,e,!0],s=e=>[t(e),e=>"Added"===e[0]];try{var r=await this.batch.do(...[].concat(...e.map(s)))}catch{throw console.log("> vernac execution failed."),new C}var i=r.length>0?r.slice(-1)[0][1]:0;return i&&await this.batch.do(["Exec",i]),i}async inspectSymbolsOfModules(e){var t=[].concat(...Object.values(e)),s=await this.runVernac(t.map((e=>`Require Import ${e}.`))),r=await this.batch.do(["Query",s,0,["Inspect",["All"]]],(e=>"SearchResults"===e[0])),i=Object.fromEntries(Object.keys(e).map((e=>[e,[]])));for(let t of r)for(let s of t[2]){var a=s.basename[1],o=s.prefix.dp[1].map((e=>e[1])).reverse(),n=o.concat(s.prefix.mod_ids.map((e=>e[1]))),c=o.join(".");for(let[t,s]of Object.entries(e))s.includes(c)&&i[t].push({prefix:n,label:a})}return i}}class C{}class F{constructor(){this.projs={},this.searchPath=new _,this.pkgDir="bin/coq",this.outDir=""}open(e,t,s={}){try{var r=JSON.parse(i().readFileSync(e));r.builddir&&(this.outDir=r.builddir),r.bundle&&(this.bundleName=r.bundle),this.openProjects(r.projects,t||r.rootdir,s)}catch(t){throw console.warn(`cannot open workspace '${e}': ${t}`),new C}}async loadDeps(e,t=""){for(let r of e){r=r.replace(/^[+]/,this.pkgDir.replace(/([^/])$/,"$1/")),r.match(/[.][^./]+$/)||(r+=".coq-pkg");var s=new w(r).fromDirectory("",await q.fromFile(o().join(t,r)));this.searchPath.addFrom(s)}}addProject(e){this.projs[e.name]=e,this.searchPath.addFrom(e),e.searchPath=this.searchPath}openProjects(e,t,s={}){var r=[],i=!1;for(let o in e)try{var a=new w(o).fromJson(e[o],t);this.addProject(a),i=!0}catch(e){if(!s.ignoreMissing)throw e;r.push([o,e])}if(!i){for(let[e,t]of r)console.warn(`in project '${e}': ${t}`);throw new Error("no valid projects found")}}openProjectDirect(e,t,s,r){var i=o().basename(e).replace(/[.][^.]*$/,"");let a=new w(i).fromJson({"":{prefix:s,dirpaths:r}},t);this.addProject(a)}createBundle(e){var t=o().basename(e).replace(/[.]json$/,"");return e.match(/[.]json$/)||(e+=".json"),{manifest:{name:t,deps:[],pkgs:[],chunks:[]},filename:e,save(){i().writeFileSync(this.filename,(0,y.neatJSON)(this.manifest))}}}listPackageContents(e){var t={},s=this._filt(e);for(let e of this.searchPath.modulesByExt(".vo")){var r=e.pkg;r&&s(r)&&(t[r]??(t[r]=[])).push(e)}return t}_filt(e){return e?"string"==typeof e?t=>t===e:t=>!!t.match(e):()=>!0}}var T=s(841),N=s.n(T);const z=require("find-up");var A=s.n(z);const L=require("glob");var I=s.n(L);const B=require("fflate-unzip");var R=s.n(B);const V=require("child-process-promise");var W=s.n(V);async function J(e,t,s){return function(e){try{return i().readFileSync(e,"utf-8")}catch{return}}(e)===t||(await s(),i().writeFileSync(e,t),!1)}function U(e){try{var t=i().statSync(e).mtime.toISOString()}catch{t="??"}return`${e} @ ${t}`}function H(e,t){try{i().unlinkSync(t)}catch{}i().symlinkSync(e,t)}async function G(e){try{var t=await async function(e="/tmp/wacoq-sdk"){N().sync(e);var t,s=function(){var e=A().sync("node_modules",{type:"directory"});if(!e)throw{err:"node_modules directory not found"};return e}();for(let e of["jscoq/coq-pkgs","wacoq-bin/bin/coq"]){var r=o().join(s,e);i().existsSync(r)&&(t=r)}if(!t)throw{err:"Package bundles (*.coq-pkg) not found"};var a=o().join(e,"coqlib");N().sync(a),await J(o().join(a,"_coq-pkgs"),U(t),(async()=>{for(let s of I().sync("*.coq-pkg",{cwd:t})){var e=o().join(t,s);await R()(e,a)}for(let e of["theories","plugins"])H("Coq",o().join(a,e))}));var n=await async function(){var e=(await W().exec("coqc -config")).stdout.match(/^COQCORELIB=(.*)/m);if(!e)throw{err:"Coq config COQCORELIB=_ not found"};return e[1]}(),c=o().join(e,"ml");return N().sync(c),await J(o().join(c,"_coqlib-native"),U(n),(()=>{for(let e of I().sync("**/*.cmxs",{cwd:n}))H(o().join(n,e),o().join(c,o().basename(e)))})),{coqlib:a,include:c}}();return(await async function(e,t){var{coqlib:s,include:r}=e;t=["-coqlib",s,"-include",r,...t];try{return await W().spawn("coqc",t,{stdio:"inherit"})}catch{throw{err:"coqc error"}}}(t,e)).code}catch(e){return e.err?console.log("oops: "+e.err):console.error(e),1}}const Q=require("wasi-kernel");var Z;!function(e){function t(e){return e<<2|1}function s(e){return e>>1}e.Val_int=t,e.Val_bool=function(e){return t(+e)},e.Int_val=s,e.Bool_val=function(e){return!!s(e)},e.Val_unit=t(0),e.Val_false=t(0),e.Val_true=t(1)}(Z||(Z={}));class X extends Q.ExecCore{constructor(e){super(e)}async run(e,t,s=[]){var r=this.opts.binDir||"../bin";for(let e of this.preloads())await this.proc.dyld.preload(e.name,e.uri,e.reloc);await this.start(`${r}/ocaml/ocamlrun.wasm`,["ocamlrun",e,...t]),this.api=this.wasm.instance.exports,this.callbacks=this._getCallbacks(s)}preloads(){var e=this.opts.binDir||"../bin";return["dllcamlstr","dllunix","dllthreads"].map((t=>({name:`${t}.so`,uri:`${e}/ocaml/${t}.wasm`,reloc:Y[t]}))).concat([{name:"dllunix.so",uri:`${e}/ocaml/dllunix.wasm`},{name:"dllnums.so",uri:`${e}/num/dllnums.wasm`},{name:"dllzarith.so",uri:`${e}/zarith/dllzarith.wasm`}])}to_caml_string(e){var t=(new TextEncoder).encode(e),s=this.api.caml_alloc_string(t.length);return this.proc.membuf.set(t,s),s}_getCallbacks(e){var t={},s=this.api.malloc(Math.max(...e.map((e=>e.length)))+1);for(let r of e){this.proc.membuf.write(r+"\0",s);let e=this.api.caml_named_value(s);e&&(t[r]=t=>this.api.caml_callback(this.proc.mem.getUint32(e,!0),t))}return this.api.free(s),t}}const Y={dllunix:{js:(K=["fstat","fsync","strchr","fcntl","ftruncate","getgrnam","gmtime","localtime","mktime","lockf","pwrite","sysconf","mmap","munmap","putenv","rewinddir","select","nanosleep","tcgetattr","tcsetattr","time","truncate"],ee=()=>0,Object.fromEntries(K.map((e=>[e,ee]))))}};var K,ee;class te{constructor(){this.checkpoint=0}setup(e){this.vec=e}pending(){if(this.vec&&"undefined"!=typeof Atomics){var e=Atomics.load(this.vec,0);if(e>this.checkpoint)return this.checkpoint=e,!0}return!1}}class se extends $.EventEmitter{constructor(e){super(),e=e||("undefined"==typeof fetch||process.env.NODE_NOW?"./bin":"../bin"),this.binDir=e,this.core=new X({stdin:!1,tty:!1,binDir:e});var t=new TextDecoder;this.core.on("stream:out",(e=>console.log(t.decode(e.data)))),this.io=new re,this.intr=new te}get fs(){return this.core.fs}async boot(){await this.upload(`${this.binDir}/icoq.bc`,"/lib/icoq.bc"),this._preloadStub(),await this.core.run("/lib/icoq.bc",[],["wacoq_post"])}async upload(e,t){var s=await this.io._fetch(e);this.putFile(t,s)}loadPackage(e,t=!0){return this.loadPackages([e],t)}async loadPackages(e,t=!0){"string"==typeof e&&(e=[e]),await Promise.all(e.map((async e=>{try{await this.unzip(e,"/lib"),this.answer([["LibLoaded",e]])}catch(t){throw this.answer([["LibError",e,t.toString()]]),t}}))),t&&this.command(["RefreshLoadPath"]),this.answer([["LoadedPkg",e]])}async loadSources(e,t){var s=t.replace(/[.]|([^/])$/g,"$1/");this.unzip(e,`/src/${s}`)}unzip(e,t){return this.io.unzip(this._pkgUri(e),((e,s)=>this.putFile(`${t}/${e}`,s)),(t=>this._progress(e,t)))}_pkgUri(e){return"+"==e[0]?`${this.binDir}/coq/${e.substring(1)}.coq-pkg`:e}_progress(e,t){this.emit("progress",{uri:e,download:t})}putFile(e,t){e.startsWith("/")||(e=`/lib/${e}`),this.fs.mkdirpSync(e.replace(/[/][^/]+$/,"")),this.fs.writeFileSync(e,t)}getFile(e){e.startsWith("/")||(e=`/lib/${e}`);var t=null;try{t=this.fs.readFileSync(e)}catch{}this.answer([["Got",e,t]])}command(e){switch(e[0]){case"LoadPkg":return void this.loadPackages(e[1]);case"Put":return void this.putFile(e[1],e[2]);case"Get":return void this.getFile(e[1]);case"InterruptSetup":return void this.intr.setup(e[1])}const t=this.core.callbacks&&this.core.callbacks.wacoq_post;if(t){var s="string"==typeof e?e:JSON.stringify(e),r=t(this.core.to_caml_string(s));this._answer(r)}}answer(e){for(let t of e)this.emit("message",t)}_answer(e){var t=this.core.proc.userGetCString(e);this.answer(JSON.parse(t))}_interrupt_pending(){return Z.Val_bool(this.intr.pending())}_preloadStub(){this.core.proc.dyld.preload("dllcoqrun_stubs.so",`${this.binDir}/coq/dllcoqrun_stubs.wasm`),this.core.proc.dyld.preload("dlllib_stubs.so",`${this.binDir}/coq/dlllib_stubs.wasm`,{js:{wacoq_emit:e=>this._answer(e),interrupt_pending:e=>this._interrupt_pending()}})}}class re{constructor(){this.pending=new Set}async unzip(e,t,s){var r=(0,g.unzipSync)(await this._fetch(e,s));for(let[e,s]of Object.entries(r))t(e,s)}async _fetch(e,t){return t&&"undefined"!=typeof fetch?this._toU8A(this._fetchWithProgress(e,t)):this._fetchSimple(e)}async _toU8A(e){return new Uint8Array(await(await e).arrayBuffer())}async _fetchSimple(e){return"undefined"!=typeof fetch?new Uint8Array(await(await fetch(e)).arrayBuffer()):(0,s(747).readFileSync)(e)}async _fetchWithProgress(e,t){var s=await fetch(e),r=+s.headers.get("Content-Length")||1e3,i=s.body.getReader(),a=[],o=0;this.pending.add(i);try{for(;;){var{value:n,done:c}=await i.read();if(c)break;a.push(n),t({total:r,downloaded:o+=n.length})}return new Blob(a)}finally{this.pending.delete(i)}}}class ie extends class{constructor(){this.volume=null,this.loadpath=[]}async do(...e){var t=[];for(let s of e)"function"==typeof s?t.push(await this.expect(s)):this.command(s);return t}isError(e){return["JsonExn","CoqExn"].includes(e[0])}async loadPackages(e){e.size>0&&await this.do(["LoadPkg",[...e].map((e=>`+${e}`))],(e=>"LoadedPkg"==e[0]))}async init(){await this.do(["Init",{}])}docOpts(e,t){return{top_name:t,mode:["Vo"],lib_init:D,lib_path:this.loadpath}}async install(e,t,s,r,i,a){console.warn("Batch.install not implemented; mod =",e)}}{constructor(e){super(),this.icoq=e,this.queue=[],this.volume={fs:e.fs,path:o()},this.icoq.on("message",(e=>this.queue.push(e)))}command(e){this.icoq.command(e)}expect(e,t=this.isError){for(;this.queue.length>0;){let s=this.queue.shift();if(e(s))return Promise.resolve(s);if(t(s))return Promise.reject(s)}return Promise.reject({reason:"expected response not found"})}}class ae extends se{constructor(){super(),this.pp=new h,this.verbose=!0,this.on("message",(e=>this.handleIncoming(e)))}async startBatch(e={}){await this.boot(),e.loads&&await this.loadPackages(e.loads);var t=new ie(this);return await t.do(["Init",{}],["NewDoc",{}],(e=>"Ready"===e[0])),t}handleIncoming(e){switch(e[0]){case"Feedback":switch(e[1].contents[0]){case"Message":console.log(this.pp.pp2Text(e[1].contents[3]))}break;case"CoqExn":e[1]&&console.error(`\n${e[1].fname[1]}:${e[1].line_nb}:`),console.error(this.pp.pp2Text(e[3]));break;default:this.verbose&&console.log(e)}}}class oe{constructor(e){this.errors=!1,this.opts=e,this.progress=process.stdout.isTTY?function(e,t=!0){process.stdout.write("\r"+e+(t?"\n":""))}:function(e,t=!0){t&&console.log(e)}}async prepare(e=this.opts){var t=new F;e.outdir&&(t.outDir=e.outdir),e.nostdlib||(t.pkgDir=oe.stdlibPkgDir(),e.loads.splice(0,0,...oe.stdlibLoads())),e.compile||await t.loadDeps(e.loads),e.workspace?t.open(e.workspace,e.rootdir,e):e.rootdir&&t.openProjectDirect(e.package||o().basename(e.rootdir),e.rootdir,e.top,e.dirpaths.split(/[, ]/)),this.workspace=t}async compile(e=this.opts){var t=this.workspace.outDir,s=new ae;await s.boot(),await s.loadPackages(e.loads);for(let[n,c]of Object.entries(this.workspace.projs)){var r=new O(new ie(s),c,e);await r.run(n);var i=await i.toPackage(e.package||o().join(t,n)),{pkg:a}=await i.save();this.progress(`wrote ${a.filename}.`,!0)}}async package(e=this.opts){var t=this.workspace.outDir,s=e.jscoq&&M.transpilePluginsJs,r=e.jscoq&&M.backportManifest;this.workspace.searchPath.createIndex();var i=this.bundle(e),a=i?void 0:e.package;for(let e in this.workspace.projs){this.progress(`[${e}] `,!1);var n=await this.workspace.projs[e].toPackage(a||o().join(t,e),void 0,s,r);try{await n.save(i&&i.manifest),this.progress(`wrote ${n.pkg.filename}.`,!0)}catch(e){this.progress(`error writing ${n.pkg.filename}:\n    `+e),this.errors=!0}}i&&(i.save(),this.progress(`wrote ${i.filename}.`,!0))}bundle(e=this.opts){return this.workspace.bundleName?this.workspace.createBundle(o().join(this.workspace.outDir,this.workspace.bundleName)):e.package&&Object.keys(this.workspace.projs).length>1?this.workspace.createBundle(e.package):void 0}async inspect(e,t=this.opts){var s=new ae;s.verbose=!1;var r=new E(await s.startBatch(t)),a=await r.inspectSymbolsOfModules(this.listModuleNames(e));for(let[e,s]of Object.entries(a)){var n=`${e.replace(/\.coq-pkg$/,"")}.symb.json`;t.outdir&&(n=o().join(t.outdir,o().basename(n))),i().writeFileSync(n,JSON.stringify({lemmas:s})),console.log(`wrote ${n}.   { lemmas: ${s.length} }`)}}listModuleNames(e){var t=this.workspace.listPackageContents(new RegExp(e.join("|")));return Object.fromEntries(Object.entries(t).map((([e,t])=>[e,t.map((e=>e.logical.join(".")))])))}static stdlib(){return s(313)}static stdlibLoads(){return[...Object.keys(this.stdlib().projects)].map((e=>`+${e}`))}static stdlibPkgDir(){return o().join(__dirname,"../bin/coq")}}(async function(){var e=[],t=0,s=c().name("wacoq").version("0.15.0");return s.command("build",{isDefault:!0}).option("--workspace <w.json>","build projects from specified workspace").option("--rootdir <dir>","toplevel directory for finding `.v` and `.vo` files").option("--top <name>","logical name of toplevel directory").option("--dirpaths <a.b.c>","logical paths containing modules (comma separated)","").option("--package <f.coq-pkg>","create a package (default extension is `.coq-pkg`)").option("-d,--outdir <dir>","set default output directory").option("--ignore-missing","skip missing projects in workspace, unless they are all missing").option("--load <f.coq-pkg>","load package(s) for compilation and for module dependencies (comma separated, may repeat)").option("--compile","compile `.v` files to `.vo`").option("--continue","pick up from previous build").option("--nostdlib","skip loading the standard Coq packages").option("--jscoq","jsCoq compatibility mode").on("option:load",(t=>e.push(...t.split(",")))).action((async s=>{t=await async function(e){if(e.args.length>0&&(!e.workspace&&e.args[0].endsWith(".json")?e.workspace=e.args.shift():e.rootdir||(e.rootdir=e.args.shift()),e.args.length>0))return console.error("extraneous arguments: ",e.args),1;var t=new oe(e);try{if(await t.prepare(),0===Object.keys(t.workspace.projs).length)throw console.error("what to build? specify either rootdir or workspace."),new C;return e.compile?await t.compile():await t.package(),t.errors?1:0}catch(e){if(e instanceof C)return 1;throw e}}({...s,loads:e})})),s.command("inspect").option("--load <f.coq-pkg>","load package(s) for compilation and for module dependencies (comma separated, may repeat)").option("-d,--outdir <dir>","set output directory").on("option:load",(t=>e.push(...t.split(",")))).action((async s=>{t=await async function(e){var t=new oe(e);try{return await t.prepare(),await t.inspect(e.args,e),t.errors?1:0}catch(e){if(e instanceof C)return 1;throw e}}({...s,loads:e})})),s.command("coqc").description("Runs `coqc` with waCoq's standard library.").allowUnknownOption(!0).helpOption("-z","(run `wacoq coqc -help` instead)").action((async e=>{await G(e.args)})),await s.parseAsync(process.argv),t})().then((e=>process.exit(e||0)))},313:e=>{e.exports=JSON.parse('{"rootdir":"vendor/coq","builddir":"coq-pkgs","bundle":"coq","projects":{"init":{"theories":{"prefix":"Coq","dirpaths":["Init","Bool","Unicode","btauto","ssr","ssrmatching"]},"plugins":{"prefix":"Coq","dirpaths":["ltac","syntax","btauto","cc","firstorder","ssr","ssrmatching"]}},"coq-base":{"theories":{"prefix":"Coq","dirpaths":["Logic","Program","Classes","Compat","Structures","Relations","Setoids","extraction","funind"]},"plugins":{"prefix":"Coq","dirpaths":["extraction","funind"]}},"coq-collections":{"theories":{"prefix":"Coq","dirpaths":["Lists","Vectors","Sets","FSets","MSets","Sorting"]}},"coq-arith":{"theories":{"prefix":"Coq","dirpaths":["Arith","NArith","PArith","ZArith","QArith","Numbers","Array","Strings","Wellfounded","setoid_ring","omega"]},"plugins":{"prefix":"Coq","dirpaths":["ring"]}},"coq-reals":{"theories":{"prefix":"Coq","dirpaths":["Reals","Floats","micromega","nsatz"]},"plugins":{"prefix":"Coq","dirpaths":["micromega","nsatz"]}},"ltac2":{"user-contrib/Ltac2":{"prefix":"Ltac2"}}}}')},129:e=>{e.exports=require("child_process")},747:e=>{e.exports=require("fs")},395:e=>{e.exports=require("jszip")},218:e=>{e.exports=require("jszip/lib/compressions")},841:e=>{e.exports=require("mkdirp")},846:e=>{e.exports=require("pako")},622:e=>{e.exports=require("path")}},r={};function i(e){var t=r[e];if(void 0!==t)return t.exports;var a=r[e]={exports:{}};return s[e](a,a.exports,i),a.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,i.t=function(s,r){if(1&r&&(s=this(s)),8&r)return s;if("object"==typeof s&&s){if(4&r&&s.__esModule)return s;if(16&r&&"function"==typeof s.then)return s}var a=Object.create(null);i.r(a);var o={};e=e||[null,t({}),t([]),t(t)];for(var n=2&r&&s;"object"==typeof n&&!~e.indexOf(n);n=t(n))Object.getOwnPropertyNames(n).forEach((e=>o[e]=()=>s[e]));return o.default=()=>s,i.d(a,o),a},i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i(696)})();